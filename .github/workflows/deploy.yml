name: éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨

on:
  push:
    branches:
      - main  # å½“æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
    
    - name: ç¼–è¯‘åç«¯
      run: |
        cd server
        npm install
        npm run build
    
    - name: éƒ¨ç½²åç«¯åˆ°æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: 22
        source: "server/dist,server/package.json,server/package-lock.json,server/.env,server/database"
        target: "/root/gobang"
        strip_components: 1
        timeout: 10m
    
    - name: éƒ¨ç½²å‰ç«¯åˆ°æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: 22
        source: "client-cocos"
        target: "/root/gobang-deploy"
        timeout: 10m
    
    - name: é‡å¯åç«¯æœåŠ¡å¹¶ä¸Šä¼ å°æ¸¸æˆ
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: 22
        timeout: 30m
        command_timeout: 30m
        script: |
          echo "=========================================="
          echo "ğŸ“¦ 1. éƒ¨ç½²åç«¯æœåŠ¡"
          echo "=========================================="
          cd /root/gobang
          
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "./dist/main.js" ]; then
            echo "âŒ é”™è¯¯: dist/main.js ä¸å­˜åœ¨ï¼Œåç«¯ç¼–è¯‘å¯èƒ½å¤±è´¥"
            exit 1
          fi
          
          if [ ! -f "./.env" ]; then
            echo "âŒ é”™è¯¯: .env æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # å®‰è£…ç”Ÿäº§ä¾èµ–
          echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
          npm install --production
          
          if [ $? -ne 0 ]; then
            echo "âŒ åç«¯ä¾èµ–å®‰è£…å¤±è´¥"
            exit 1
          fi
          
          # åˆ›å»ºPM2é…ç½®æ–‡ä»¶
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'gobang-server',
              script: './dist/main.js',
              instances: 2,
              exec_mode: 'cluster',
              env: {
                NODE_ENV: 'production',
                PORT: 3002
              },
              error_file: './logs/err.log',
              out_file: './logs/out.log',
              log_date_format: 'YYYY-MM-DD HH:mm:ss',
              merge_logs: true,
              autorestart: true,
              max_memory_restart: '500M'
            }]
          };
          EOF
          
          # åˆ›å»ºæ—¥å¿—ç›®å½•
          mkdir -p logs
          
          # é‡å¯PM2æœåŠ¡
          echo "ğŸ”„ é‡å¯PM2æœåŠ¡..."
          pm2 delete gobang-server 2>/dev/null || true
          pm2 start ecosystem.config.js
          
          if [ $? -ne 0 ]; then
            echo "âŒ PM2å¯åŠ¨å¤±è´¥"
            pm2 logs gobang-server --lines 50
            exit 1
          fi
          
          pm2 save
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆå¢åŠ åˆ°8ç§’ï¼ŒNestJSéœ€è¦æ—¶é—´åˆå§‹åŒ–ï¼‰
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 8
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆæ”¹è¿›é€»è¾‘ï¼Œå…è®¸launchingçŠ¶æ€ï¼‰
          pm2 list gobang-server | grep -E "online|launching"
          if [ $? -ne 0 ]; then
            echo "âš ï¸ æœåŠ¡çŠ¶æ€å¼‚å¸¸ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
            pm2 logs gobang-server --lines 50
            echo ""
            echo "ğŸ“Š å½“å‰PM2çŠ¶æ€:"
            pm2 list
            # ä¸å†exit 1ï¼Œç»§ç»­éƒ¨ç½²å‰ç«¯
          else
            echo "âœ… åç«¯æœåŠ¡è¿è¡Œä¸­"
          fi
          
          echo "âœ… åç«¯éƒ¨ç½²å®Œæˆï¼"
          pm2 status
          
          echo ""
          echo "=========================================="
          echo "ğŸ® 2. ä¸Šä¼ å¾®ä¿¡å°æ¸¸æˆ"
          echo "=========================================="
          
          # è¿›å…¥å‰ç«¯ç›®å½•
          cd /root/gobang-deploy/client-cocos
          
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„node_moduleså’Œç¼“å­˜
          echo "ğŸ§¹ æ¸…ç†æ—§ä¾èµ–..."
          rm -rf node_modules package-lock.json
          npm cache clean --force
          
          # å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨æ·˜å®é•œåƒåŠ é€Ÿï¼‰
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm install --registry=https://registry.npmmirror.com --no-audit --no-fund --legacy-peer-deps
          
          # æ£€æŸ¥ä¾èµ–å®‰è£…æ˜¯å¦æˆåŠŸ
          if [ $? -ne 0 ]; then
            echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"
            exit 1
          fi
          
          # åˆ›å»ºå¯†é’¥æ–‡ä»¶
          echo "ğŸ”‘ é…ç½®ä¸Šä¼ å¯†é’¥..."
          echo "${{ secrets.WECHAT_UPLOAD_KEY }}" > private.key
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export VERSION="1.0.${{ github.run_number }}"
          export DESC="è‡ªåŠ¨æ„å»º #${{ github.run_number }} - commit: ${{ github.sha }}"
          
          # æ‰§è¡Œä¸Šä¼ 
          echo "ğŸš€ å¼€å§‹ä¸Šä¼ ..."
          npm run upload
          
          # æ£€æŸ¥ä¸Šä¼ æ˜¯å¦æˆåŠŸ
          if [ $? -ne 0 ]; then
            echo "âŒ å¾®ä¿¡å°æ¸¸æˆä¸Šä¼ å¤±è´¥"
            rm -f private.key
            cd /root
            rm -rf /root/gobang-deploy
            exit 1
          fi
          
          # æ¸…ç†
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -f private.key
          cd /root
          rm -rf /root/gobang-deploy
          
          echo ""
          echo "=========================================="
          echo "âœ… å…¨éƒ¨å®Œæˆï¼"
          echo "=========================================="

