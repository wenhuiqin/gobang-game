# äº”å­æ£‹å¾®ä¿¡å°æ¸¸æˆ - å¼€å‘è§„èŒƒæ–‡æ¡£

> **é‡è¦æç¤ºï¼šæ¯ä½å¼€å‘äººå‘˜åœ¨å¼€å§‹ç¼–ç å‰ï¼Œå¿…é¡»å®Œæ•´é˜…è¯» `docs/` æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡æ¡£ï¼Œç¡®ä¿ç†è§£é¡¹ç›®æ•´ä½“æ¶æ„ã€äº§å“éœ€æ±‚å’ŒæŠ€æœ¯æ–¹æ¡ˆï¼Œé¿å…å¼€å‘æ€è·¯åç¦»ï¼**

---

## ä¸€ã€æ–‡æ¡£é˜…è¯»è§„èŒƒ

### 1.1 å¿…è¯»æ–‡æ¡£æ¸…å•

åœ¨å¼€å§‹ä»»ä½•å¼€å‘å·¥ä½œå‰ï¼Œå¿…é¡»æŒ‰é¡ºåºé˜…è¯»ä»¥ä¸‹æ–‡æ¡£ï¼š

1. **äº§å“éœ€æ±‚æ–‡æ¡£.md** - äº†è§£äº§å“å®šä½ã€åŠŸèƒ½éœ€æ±‚ã€ä¸šåŠ¡é€»è¾‘
2. **æŠ€æœ¯å¼€å‘æ–‡æ¡£.md** - äº†è§£æŠ€æœ¯æ¶æ„ã€æ•°æ®åº“è®¾è®¡ã€APIè®¾è®¡
3. **å¼€å‘è§„èŒƒæ–‡æ¡£.md**ï¼ˆæœ¬æ–‡æ¡£ï¼‰- éµå¾ªä»£ç è§„èŒƒå’Œå¼€å‘æµç¨‹

### 1.2 å¼€å‘å‰è‡ªæŸ¥æ¸…å•

- [ ] å·²é˜…è¯»å¹¶ç†è§£äº§å“éœ€æ±‚æ–‡æ¡£
- [ ] å·²é˜…è¯»å¹¶ç†è§£æŠ€æœ¯å¼€å‘æ–‡æ¡£
- [ ] å·²é˜…è¯»å¹¶ç†è§£å¼€å‘è§„èŒƒæ–‡æ¡£
- [ ] äº†è§£å½“å‰è¿­ä»£çš„åŠŸèƒ½éœ€æ±‚
- [ ] äº†è§£ç›¸å…³æ¨¡å—çš„æ•°æ®åº“è®¾è®¡
- [ ] äº†è§£ç›¸å…³çš„APIæ¥å£è®¾è®¡
- [ ] æ¸…æ¥šä»£ç è§„èŒƒå’Œå‘½åè§„èŒƒ

### 1.3 æ–‡æ¡£æ›´æ–°è§„èŒƒ

- ä»»ä½•æ¶æ„å˜æ›´ã€éœ€æ±‚å˜æ›´å¿…é¡»å…ˆæ›´æ–°ç›¸å…³æ–‡æ¡£
- æ–‡æ¡£æ›´æ–°åéœ€é€šçŸ¥å…¨ä½“å¼€å‘äººå‘˜
- æ¯æ¬¡è¿­ä»£å¼€å§‹å‰ï¼Œé‡æ–°å®¡é˜…docsæ–‡æ¡£

---

## äºŒã€æ ¸å¿ƒå¼€å‘åŸåˆ™

### 2.1 ç¦æ­¢ç¡¬ç¼–ç åŸåˆ™ âš ï¸

**ç¡¬ç¼–ç æ˜¯æŒ‡ç›´æ¥åœ¨ä»£ç ä¸­å†™å…¥å›ºå®šå€¼ï¼Œè€Œä¸æ˜¯é€šè¿‡é…ç½®ã€å¸¸é‡æˆ–æ•°æ®åº“è·å–ã€‚**

#### âŒ ç¦æ­¢çš„ç¡¬ç¼–ç ç¤ºä¾‹

```typescript
// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç é­”æ³•æ•°å­—
if (user.level > 10) {
  // ...
}

// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç å­—ç¬¦ä¸²
if (game.status === 'playing') {
  // ...
}

// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç URL
const apiUrl = 'https://api.example.com/game';

// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç æ—¶é—´
setTimeout(() => {}, 30000);

// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç é…ç½®
const ratingChange = score * 10;

// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç æ£‹ç›˜å¤§å°
for (let i = 0; i < 15; i++) {
  for (let j = 0; j < 15; j++) {
    // ...
  }
}
```

#### âœ… æ­£ç¡®çš„å®ç°æ–¹å¼

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¸¸é‡
import { USER_LEVEL } from '@/common/constants/user.constants';
if (user.level > USER_LEVEL.INTERMEDIATE_THRESHOLD) {
  // ...
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æšä¸¾
enum GameStatus {
  WAITING = 'waiting',
  PLAYING = 'playing',
  FINISHED = 'finished'
}
if (game.status === GameStatus.PLAYING) {
  // ...
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡
const apiUrl = this.configService.get('API_BASE_URL');

// âœ… æ­£ç¡®ï¼šä½¿ç”¨é…ç½®å¸¸é‡
import { GAME_CONFIG } from '@/common/constants/game.constants';
setTimeout(() => {}, GAME_CONFIG.TURN_TIMEOUT);

// âœ… æ­£ç¡®ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶
const ratingChange = score * this.configService.get('RATING_MULTIPLIER');

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¸¸é‡
import { BOARD_SIZE } from '@/common/constants/game.constants';
for (let i = 0; i < BOARD_SIZE; i++) {
  for (let j = 0; j < BOARD_SIZE; j++) {
    // ...
  }
}
```

### 2.2 é…ç½®ç®¡ç†è§„èŒƒ

#### 2.2.1 ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ.envï¼‰

æ‰€æœ‰ç¯å¢ƒç›¸å…³çš„é…ç½®å¿…é¡»ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼š

```bash
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=your_password
DB_DATABASE=gomoku

# Redisé…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# å¾®ä¿¡é…ç½®
WECHAT_APP_ID=your_app_id
WECHAT_APP_SECRET=your_app_secret

# JWTé…ç½®
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=7d

# æœåŠ¡é…ç½®
PORT=3000
NODE_ENV=development
```

#### 2.2.2 å¸¸é‡å®šä¹‰ï¼ˆconstantsï¼‰

æ‰€æœ‰ä¸šåŠ¡ç›¸å…³çš„å¸¸é‡å¿…é¡»å®šä¹‰åœ¨ `src/common/constants/` ç›®å½•ä¸‹ï¼š

**game.constants.ts - æ¸¸æˆå¸¸é‡**
```typescript
/**
 * æ¸¸æˆé…ç½®å¸¸é‡
 * ç¦æ­¢åœ¨ä»£ç ä¸­ç›´æ¥ä½¿ç”¨æ•°å­—ï¼Œå¿…é¡»ä½¿ç”¨æ­¤å¤„å®šä¹‰çš„å¸¸é‡
 */
export const GAME_CONFIG = {
  // æ£‹ç›˜é…ç½®
  BOARD_SIZE: 15,                    // æ£‹ç›˜å¤§å° 15x15
  WIN_COUNT: 5,                      // èƒœåˆ©æ‰€éœ€è¿å­æ•°
  
  // æ—¶é—´é…ç½®ï¼ˆæ¯«ç§’ï¼‰
  TURN_TIMEOUT: 30 * 1000,           // æ¯æ­¥è¶…æ—¶æ—¶é—´ 30ç§’
  TURN_WARNING_TIME: 10 * 1000,      // è¶…æ—¶è­¦å‘Šæ—¶é—´ 10ç§’
  MATCH_TIMEOUT: 30 * 1000,          // åŒ¹é…è¶…æ—¶æ—¶é—´ 30ç§’
  ROOM_EXPIRE_TIME: 30 * 60 * 1000,  // æˆ¿é—´è¿‡æœŸæ—¶é—´ 30åˆ†é’Ÿ
  
  // åŒ¹é…é…ç½®
  MATCH_RATING_DIFF_BASE: 100,       // åŸºç¡€è¯„åˆ†å·®
  MATCH_RATING_DIFF_INCREMENT: 10,   // æ¯ç§’å¢åŠ çš„è¯„åˆ†å·®
  
  // AIé…ç½®
  AI_DEPTH_EASY: 2,                  // ç®€å•AIæ·±åº¦
  AI_DEPTH_MEDIUM: 4,                // ä¸­ç­‰AIæ·±åº¦
  AI_DEPTH_HARD: 6,                  // å›°éš¾AIæ·±åº¦
  
  // è¯„åˆ†é…ç½®
  RATING_DEFAULT: 1000,              // é»˜è®¤è¯„åˆ†
  RATING_K_FACTOR: 32,               // ELO Kå› å­
  
  // ç»éªŒé…ç½®
  EXP_PER_WIN: 50,                   // èƒœåˆ©ç»éªŒ
  EXP_PER_LOSE: 20,                  // å¤±è´¥ç»éªŒ
  EXP_PER_DRAW: 30,                  // å¹³å±€ç»éªŒ
} as const;

/**
 * æ¸¸æˆç±»å‹æšä¸¾
 */
export enum GameType {
  RANDOM_MATCH = 1,  // éšæœºåŒ¹é…
  AI_GAME = 2,       // äººæœºå¯¹æˆ˜
  FRIEND_GAME = 3,   // å¥½å‹å¯¹æˆ˜
}

/**
 * æ¸¸æˆç»“æœæšä¸¾
 */
export enum GameResult {
  BLACK_WIN = 1,      // é»‘æ–¹èƒœ
  WHITE_WIN = 2,      // ç™½æ–¹èƒœ
  DRAW = 3,           // å¹³å±€
  BLACK_TIMEOUT = 4,  // é»‘æ–¹è¶…æ—¶
  WHITE_TIMEOUT = 5,  // ç™½æ–¹è¶…æ—¶
}

/**
 * æ£‹å­é¢œè‰²æšä¸¾
 */
export enum PieceColor {
  EMPTY = 0,   // ç©ºä½
  BLACK = 1,   // é»‘å­
  WHITE = 2,   // ç™½å­
}

/**
 * æˆ¿é—´çŠ¶æ€æšä¸¾
 */
export enum RoomStatus {
  WAITING = 1,    // ç­‰å¾…ä¸­
  PLAYING = 2,    // è¿›è¡Œä¸­
  FINISHED = 3,   // å·²ç»“æŸ
}
```

**user.constants.ts - ç”¨æˆ·å¸¸é‡**
```typescript
/**
 * ç”¨æˆ·ç­‰çº§é…ç½®
 */
export const USER_LEVEL_CONFIG = [
  { level: 1, exp: 0, name: 'æ–°æ‰‹' },
  { level: 2, exp: 100, name: 'åˆå­¦è€…' },
  { level: 3, exp: 300, name: 'çˆ±å¥½è€…' },
  { level: 4, exp: 600, name: 'ç†Ÿç»ƒè€…' },
  { level: 5, exp: 1000, name: 'é«˜æ‰‹' },
  { level: 6, exp: 1500, name: 'ä¸“å®¶' },
  { level: 7, exp: 2100, name: 'å¤§å¸ˆ' },
  { level: 8, exp: 2800, name: 'å®—å¸ˆ' },
  { level: 9, exp: 3600, name: 'ä¼ å¥‡' },
  { level: 10, exp: 4500, name: 'è‡³å°Š' },
] as const;

/**
 * æ’è¡Œæ¦œç±»å‹
 */
export enum RankType {
  WIN = 'win',           // èƒœåœºæ¦œ
  WIN_RATE = 'winrate',  // èƒœç‡æ¦œ
  STREAK = 'streak',     // è¿èƒœæ¦œ
}

/**
 * æ’è¡Œæ¦œå‘¨æœŸ
 */
export enum RankPeriod {
  DAILY = 'daily',     // æ—¥æ¦œ
  WEEKLY = 'weekly',   // å‘¨æ¦œ
  MONTHLY = 'monthly', // æœˆæ¦œ
  ALL = 'all',         // æ€»æ¦œ
}

/**
 * æ’è¡Œæ¦œé…ç½®
 */
export const RANK_CONFIG = {
  MAX_RANK_SIZE: 100,           // æœ€å¤§æ’è¡Œæ•°é‡
  MIN_GAMES_FOR_WINRATE: 10,    // èƒœç‡æ¦œæœ€å°‘å¯¹å±€æ•°
  CACHE_TTL: 300,                // ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰
} as const;
```

**error-codes.constants.ts - é”™è¯¯ç å¸¸é‡**
```typescript
/**
 * é”™è¯¯ç å®šä¹‰
 * æ ¼å¼ï¼šæ¨¡å—(2ä½) + å…·ä½“é”™è¯¯(3ä½)
 */
export const ERROR_CODES = {
  // é€šç”¨é”™è¯¯ (00xxx)
  SUCCESS: 0,
  UNKNOWN_ERROR: 500,
  PARAMS_ERROR: 400,
  
  // è®¤è¯é”™è¯¯ (10xxx)
  AUTH_TOKEN_INVALID: 10001,
  AUTH_TOKEN_EXPIRED: 10002,
  AUTH_WECHAT_LOGIN_FAILED: 10003,
  
  // ç”¨æˆ·é”™è¯¯ (20xxx)
  USER_NOT_FOUND: 20001,
  USER_ALREADY_EXISTS: 20002,
  
  // æ¸¸æˆé”™è¯¯ (30xxx)
  GAME_NOT_FOUND: 30001,
  GAME_ALREADY_STARTED: 30002,
  GAME_ALREADY_FINISHED: 30003,
  GAME_INVALID_MOVE: 30004,
  GAME_NOT_YOUR_TURN: 30005,
  GAME_POSITION_OCCUPIED: 30006,
  
  // æˆ¿é—´é”™è¯¯ (40xxx)
  ROOM_NOT_FOUND: 40001,
  ROOM_FULL: 40002,
  ROOM_PASSWORD_ERROR: 40003,
  ROOM_EXPIRED: 40004,
  
  // åŒ¹é…é”™è¯¯ (50xxx)
  MATCH_TIMEOUT: 50001,
  MATCH_ALREADY_IN_QUEUE: 50002,
} as const;

/**
 * é”™è¯¯æ¶ˆæ¯æ˜ å°„
 */
export const ERROR_MESSAGES: Record<number, string> = {
  [ERROR_CODES.SUCCESS]: 'æˆåŠŸ',
  [ERROR_CODES.UNKNOWN_ERROR]: 'æœªçŸ¥é”™è¯¯',
  [ERROR_CODES.PARAMS_ERROR]: 'å‚æ•°é”™è¯¯',
  
  [ERROR_CODES.AUTH_TOKEN_INVALID]: 'Tokenæ— æ•ˆ',
  [ERROR_CODES.AUTH_TOKEN_EXPIRED]: 'Tokenå·²è¿‡æœŸ',
  [ERROR_CODES.AUTH_WECHAT_LOGIN_FAILED]: 'å¾®ä¿¡ç™»å½•å¤±è´¥',
  
  [ERROR_CODES.USER_NOT_FOUND]: 'ç”¨æˆ·ä¸å­˜åœ¨',
  [ERROR_CODES.USER_ALREADY_EXISTS]: 'ç”¨æˆ·å·²å­˜åœ¨',
  
  [ERROR_CODES.GAME_NOT_FOUND]: 'æ¸¸æˆä¸å­˜åœ¨',
  [ERROR_CODES.GAME_ALREADY_STARTED]: 'æ¸¸æˆå·²å¼€å§‹',
  [ERROR_CODES.GAME_ALREADY_FINISHED]: 'æ¸¸æˆå·²ç»“æŸ',
  [ERROR_CODES.GAME_INVALID_MOVE]: 'æ— æ•ˆçš„è½å­',
  [ERROR_CODES.GAME_NOT_YOUR_TURN]: 'è¿˜æ²¡è½®åˆ°ä½ ',
  [ERROR_CODES.GAME_POSITION_OCCUPIED]: 'è¯¥ä½ç½®å·²è¢«å ç”¨',
  
  [ERROR_CODES.ROOM_NOT_FOUND]: 'æˆ¿é—´ä¸å­˜åœ¨',
  [ERROR_CODES.ROOM_FULL]: 'æˆ¿é—´å·²æ»¡',
  [ERROR_CODES.ROOM_PASSWORD_ERROR]: 'æˆ¿é—´å¯†ç é”™è¯¯',
  [ERROR_CODES.ROOM_EXPIRED]: 'æˆ¿é—´å·²è¿‡æœŸ',
  
  [ERROR_CODES.MATCH_TIMEOUT]: 'åŒ¹é…è¶…æ—¶',
  [ERROR_CODES.MATCH_ALREADY_IN_QUEUE]: 'å·²åœ¨åŒ¹é…é˜Ÿåˆ—ä¸­',
};
```

### 2.3 ä½¿ç”¨é…ç½®çš„æœ€ä½³å®è·µ

```typescript
// âœ… åœ¨Serviceä¸­ä½¿ç”¨é…ç½®
import { Injectable } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { GAME_CONFIG, GameStatus } from '@/common/constants/game.constants';

@Injectable()
export class GameService {
  constructor(private configService: ConfigService) {}
  
  async checkTimeout(gameId: string): Promise<boolean> {
    const game = await this.findGame(gameId);
    const now = Date.now();
    const turnStartTime = game.turnStartTime.getTime();
    
    // âœ… ä½¿ç”¨å¸¸é‡è€Œä¸æ˜¯ç¡¬ç¼–ç 
    return (now - turnStartTime) > GAME_CONFIG.TURN_TIMEOUT;
  }
  
  async initializeBoard(): Promise<number[][]> {
    // âœ… ä½¿ç”¨å¸¸é‡å®šä¹‰æ£‹ç›˜å¤§å°
    const board = Array(GAME_CONFIG.BOARD_SIZE)
      .fill(null)
      .map(() => Array(GAME_CONFIG.BOARD_SIZE).fill(0));
    
    return board;
  }
}
```

---

## ä¸‰ã€NestJS å¼€å‘è§„èŒƒ

### 3.1 æ¨¡å—åŒ–å¼€å‘

#### 3.1.1 æ¨¡å—ç»“æ„

æ¯ä¸ªåŠŸèƒ½æ¨¡å—å¿…é¡»åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼ˆæŒ‰éœ€ï¼‰ï¼š

```
module-name/
â”œâ”€â”€ module-name.module.ts      # æ¨¡å—å®šä¹‰
â”œâ”€â”€ module-name.controller.ts  # æ§åˆ¶å™¨ï¼ˆHTTPï¼‰
â”œâ”€â”€ module-name.gateway.ts     # ç½‘å…³ï¼ˆWebSocketï¼‰
â”œâ”€â”€ module-name.service.ts     # æœåŠ¡ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”œâ”€â”€ dto/                       # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ create-xxx.dto.ts
â”‚   â”œâ”€â”€ update-xxx.dto.ts
â”‚   â””â”€â”€ query-xxx.dto.ts
â””â”€â”€ entities/                  # å®ä½“ç±»
    â””â”€â”€ xxx.entity.ts
```

#### 3.1.2 æ¨¡å—ç¤ºä¾‹

```typescript
// game.module.ts
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { GameController } from './game.controller';
import { GameGateway } from './game.gateway';
import { GameService } from './game.service';
import { GameRecord } from './entities/game-record.entity';
import { UserModule } from '../user/user.module';

@Module({
  imports: [
    TypeOrmModule.forFeature([GameRecord]),
    UserModule, // å¯¼å…¥éœ€è¦çš„å…¶ä»–æ¨¡å—
  ],
  controllers: [GameController],
  providers: [GameGateway, GameService],
  exports: [GameService], // å¯¼å‡ºä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
})
export class GameModule {}
```

### 3.2 ä¾èµ–æ³¨å…¥è§„èŒƒ

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥
@Injectable()
export class GameService {
  constructor(
    @InjectRepository(GameRecord)
    private gameRecordRepository: Repository<GameRecord>,
    private userService: UserService,
    private redisService: RedisService,
    private configService: ConfigService,
  ) {}
}

// âŒ é”™è¯¯ï¼šä¸è¦ä½¿ç”¨å±æ€§æ³¨å…¥
@Injectable()
export class GameService {
  @Inject(UserService)
  private userService: UserService;  // ä¸æ¨è
}
```

### 3.3 Controller å¼€å‘è§„èŒƒ

```typescript
import { Controller, Get, Post, Body, Param, Query, UseGuards } from '@nestjs/common';
import { JwtAuthGuard } from '@/common/guards/jwt-auth.guard';
import { CurrentUser } from '@/common/decorators/user.decorator';
import { GameService } from './game.service';
import { CreateRoomDto } from './dto/create-room.dto';

@Controller('api/game')
@UseGuards(JwtAuthGuard) // ç»Ÿä¸€ä½¿ç”¨JWTå®ˆå«
export class GameController {
  constructor(private readonly gameService: GameService) {}
  
  /**
   * åˆ›å»ºæˆ¿é—´
   * @param user å½“å‰ç”¨æˆ·
   * @param dto åˆ›å»ºæˆ¿é—´DTO
   */
  @Post('room/create')
  async createRoom(
    @CurrentUser() user: any,
    @Body() dto: CreateRoomDto,
  ) {
    return this.gameService.createRoom(user.id, dto);
  }
  
  /**
   * è·å–æ¸¸æˆå†å²
   * @param user å½“å‰ç”¨æˆ·
   * @param page é¡µç 
   * @param limit æ¯é¡µæ•°é‡
   */
  @Get('history')
  async getHistory(
    @CurrentUser() user: any,
    @Query('page') page: number = 1,
    @Query('limit') limit: number = 20,
  ) {
    return this.gameService.getHistory(user.id, page, limit);
  }
}
```

### 3.4 Service å¼€å‘è§„èŒƒ

```typescript
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { GameRecord } from './entities/game-record.entity';
import { GAME_CONFIG } from '@/common/constants/game.constants';
import { ERROR_CODES } from '@/common/constants/error-codes.constants';

@Injectable()
export class GameService {
  constructor(
    @InjectRepository(GameRecord)
    private gameRecordRepository: Repository<GameRecord>,
  ) {}
  
  /**
   * æŸ¥æ‰¾æ¸¸æˆè®°å½•
   * @param gameId æ¸¸æˆID
   * @throws NotFoundException æ¸¸æˆä¸å­˜åœ¨
   */
  async findGameById(gameId: string): Promise<GameRecord> {
    const game = await this.gameRecordRepository.findOne({
      where: { id: gameId },
    });
    
    if (!game) {
      throw new NotFoundException({
        code: ERROR_CODES.GAME_NOT_FOUND,
        message: 'æ¸¸æˆä¸å­˜åœ¨',
      });
    }
    
    return game;
  }
  
  /**
   * æ£€æŸ¥èƒœåˆ©æ¡ä»¶
   * @param board æ£‹ç›˜
   * @param x Xåæ ‡
   * @param y Yåæ ‡
   * @param color æ£‹å­é¢œè‰²
   */
  checkWin(board: number[][], x: number, y: number, color: number): boolean {
    // âœ… ä½¿ç”¨å¸¸é‡
    const directions = [
      [[0, 1], [0, -1]],   // æ°´å¹³
      [[1, 0], [-1, 0]],   // å‚ç›´
      [[1, 1], [-1, -1]],  // ä¸»å¯¹è§’çº¿
      [[1, -1], [-1, 1]],  // å‰¯å¯¹è§’çº¿
    ];
    
    for (const [dir1, dir2] of directions) {
      let count = 1;
      count += this.countDirection(board, x, y, dir1[0], dir1[1], color);
      count += this.countDirection(board, x, y, dir2[0], dir2[1], color);
      
      // âœ… ä½¿ç”¨å¸¸é‡è€Œä¸æ˜¯ç¡¬ç¼–ç æ•°å­—5
      if (count >= GAME_CONFIG.WIN_COUNT) {
        return true;
      }
    }
    
    return false;
  }
  
  private countDirection(
    board: number[][],
    x: number,
    y: number,
    dx: number,
    dy: number,
    color: number,
  ): number {
    let count = 0;
    let nx = x + dx;
    let ny = y + dy;
    
    // âœ… ä½¿ç”¨å¸¸é‡
    while (
      nx >= 0 && nx < GAME_CONFIG.BOARD_SIZE &&
      ny >= 0 && ny < GAME_CONFIG.BOARD_SIZE &&
      board[nx][ny] === color
    ) {
      count++;
      nx += dx;
      ny += dy;
    }
    
    return count;
  }
}
```

### 3.5 WebSocket Gateway å¼€å‘è§„èŒƒ

```typescript
import {
  WebSocketGateway,
  WebSocketServer,
  SubscribeMessage,
  ConnectedSocket,
  MessageBody,
  OnGatewayConnection,
  OnGatewayDisconnect,
} from '@nestjs/websockets';
import { Server, Socket } from 'socket.io';
import { UseGuards } from '@nestjs/common';
import { WsJwtGuard } from '@/common/guards/ws-jwt.guard';
import { GameService } from './game.service';

@WebSocketGateway({
  cors: {
    origin: '*',
  },
})
export class GameGateway implements OnGatewayConnection, OnGatewayDisconnect {
  @WebSocketServer()
  server: Server;
  
  constructor(private readonly gameService: GameService) {}
  
  /**
   * å®¢æˆ·ç«¯è¿æ¥
   */
  async handleConnection(client: Socket) {
    console.log(`Client connected: ${client.id}`);
  }
  
  /**
   * å®¢æˆ·ç«¯æ–­å¼€
   */
  async handleDisconnect(client: Socket) {
    console.log(`Client disconnected: ${client.id}`);
    await this.gameService.handleDisconnect(client.id);
  }
  
  /**
   * å¤„ç†è½å­äº‹ä»¶
   */
  @UseGuards(WsJwtGuard)
  @SubscribeMessage('make_move')
  async handleMove(
    @ConnectedSocket() client: Socket,
    @MessageBody() data: { roomId: string; x: number; y: number },
  ) {
    const result = await this.gameService.makeMove(
      client.data.userId,
      data.roomId,
      data.x,
      data.y,
    );
    
    // å¹¿æ’­ç»™æˆ¿é—´å†…æ‰€æœ‰ç©å®¶
    this.server.to(data.roomId).emit('opponent_move', result);
    
    return result;
  }
}
```

### 3.6 DTO å¼€å‘è§„èŒƒ

ä½¿ç”¨ `class-validator` è¿›è¡Œæ•°æ®éªŒè¯ï¼š

```typescript
import { IsString, IsOptional, IsInt, Min, Max, Length } from 'class-validator';
import { Type } from 'class-transformer';

/**
 * åˆ›å»ºæˆ¿é—´DTO
 */
export class CreateRoomDto {
  @IsOptional()
  @IsString()
  @Length(4, 20, { message: 'å¯†ç é•¿åº¦å¿…é¡»åœ¨4-20ä½ä¹‹é—´' })
  password?: string;
}

/**
 * è½å­DTO
 */
export class MakeMoveDto {
  @IsString()
  roomId: string;
  
  @IsInt({ message: 'Xåæ ‡å¿…é¡»æ˜¯æ•´æ•°' })
  @Min(0, { message: 'Xåæ ‡ä¸èƒ½å°äº0' })
  @Max(14, { message: 'Xåæ ‡ä¸èƒ½å¤§äº14' })
  @Type(() => Number)
  x: number;
  
  @IsInt({ message: 'Yåæ ‡å¿…é¡»æ˜¯æ•´æ•°' })
  @Min(0, { message: 'Yåæ ‡ä¸èƒ½å°äº0' })
  @Max(14, { message: 'Yåæ ‡ä¸èƒ½å¤§äº14' })
  @Type(() => Number)
  y: number;
}

/**
 * åˆ†é¡µæŸ¥è¯¢DTO
 */
export class PaginationDto {
  @IsOptional()
  @IsInt()
  @Min(1)
  @Type(() => Number)
  page?: number = 1;
  
  @IsOptional()
  @IsInt()
  @Min(1)
  @Max(100)
  @Type(() => Number)
  limit?: number = 20;
}
```

### 3.7 Entity å¼€å‘è§„èŒƒ

```typescript
import {
  Entity,
  Column,
  PrimaryGeneratedColumn,
  CreateDateColumn,
  UpdateDateColumn,
  Index,
} from 'typeorm';
import { GameType, GameResult } from '@/common/constants/game.constants';

@Entity('game_records')
export class GameRecord {
  @PrimaryGeneratedColumn('increment', { type: 'bigint', unsigned: true })
  id: string;
  
  @Column({ type: 'varchar', length: 64, name: 'room_id' })
  roomId: string;
  
  @Column({ type: 'tinyint', name: 'game_type', comment: 'æ¸¸æˆç±»å‹' })
  gameType: GameType;
  
  @Column({ type: 'bigint', unsigned: true, name: 'black_player_id', nullable: true })
  blackPlayerId: string;
  
  @Column({ type: 'bigint', unsigned: true, name: 'white_player_id', nullable: true })
  whitePlayerId: string;
  
  @Column({ type: 'bigint', unsigned: true, name: 'winner_id', nullable: true })
  winnerId: string;
  
  @Column({ type: 'tinyint', name: 'game_result' })
  gameResult: GameResult;
  
  @Column({ type: 'int', default: 0, name: 'total_steps' })
  totalSteps: number;
  
  @Column({ type: 'int', default: 0, comment: 'å¯¹å±€æ—¶é•¿(ç§’)' })
  duration: number;
  
  @Column({ type: 'text', name: 'game_data', nullable: true })
  gameData: string;
  
  @Column({ type: 'tinyint', name: 'ai_difficulty', nullable: true })
  aiDifficulty: number;
  
  @Column({ type: 'datetime', name: 'started_at' })
  startedAt: Date;
  
  @Column({ type: 'datetime', name: 'ended_at' })
  endedAt: Date;
  
  @CreateDateColumn({ type: 'datetime', name: 'created_at' })
  createdAt: Date;
  
  @Index()
  @Column({ type: 'bigint', unsigned: true, name: 'black_player_id' })
  blackPlayerIdIndex: string;
}
```

---

## å››ã€ä»£ç è§„èŒƒ

### 4.1 å‘½åè§„èŒƒ

#### 4.1.1 æ–‡ä»¶å‘½å

- **æ¨¡å—æ–‡ä»¶ï¼š** `xxx.module.ts`
- **æ§åˆ¶å™¨æ–‡ä»¶ï¼š** `xxx.controller.ts`
- **æœåŠ¡æ–‡ä»¶ï¼š** `xxx.service.ts`
- **ç½‘å…³æ–‡ä»¶ï¼š** `xxx.gateway.ts`
- **å®ä½“æ–‡ä»¶ï¼š** `xxx.entity.ts`
- **DTOæ–‡ä»¶ï¼š** `xxx.dto.ts`
- **å¸¸é‡æ–‡ä»¶ï¼š** `xxx.constants.ts`
- **å·¥å…·æ–‡ä»¶ï¼š** `xxx.util.ts`

#### 4.1.2 å˜é‡å‘½å

```typescript
// âœ… æ­£ç¡®çš„å‘½å
const userName = 'John';           // é©¼å³°å‘½å
const MAX_RETRY_COUNT = 3;        // å¸¸é‡å¤§å†™
const gameService: GameService;    // ç±»å‹æ³¨è§£

// âŒ é”™è¯¯çš„å‘½å
const user_name = 'John';          // ä¸è¦ä½¿ç”¨ä¸‹åˆ’çº¿
const maxretrycount = 3;           // å¸¸é‡è¦å¤§å†™
const gs: GameService;             // é¿å…ç¼©å†™
```

#### 4.1.3 å‡½æ•°å‘½å

```typescript
// âœ… åŠ¨è¯å¼€å¤´ï¼Œè¯­ä¹‰æ¸…æ™°
async createGame() {}
async findGameById(id: string) {}
async updateUserScore(userId: string, score: number) {}
async deleteExpiredRooms() {}
async isGameFinished(gameId: string): Promise<boolean> {}
async hasPermission(userId: string): Promise<boolean> {}

// âŒ é¿å…
async game() {}              // ä¸æ¸…æ™°
async data() {}              // å¤ªæ³›åŒ–
async process() {}           // ä¸æ˜ç¡®
```

#### 4.1.4 ç±»å‘½å

```typescript
// âœ… ä½¿ç”¨PascalCaseï¼Œåè¯
class GameService {}
class UserController {}
class GameRecord {}
class CreateRoomDto {}

// âŒ é¿å…
class gameService {}         // é¦–å­—æ¯è¦å¤§å†™
class Game_Service {}        // ä¸è¦ä½¿ç”¨ä¸‹åˆ’çº¿
```

### 4.2 æ³¨é‡Šè§„èŒƒ

#### 4.2.1 æ–‡ä»¶å¤´æ³¨é‡Š

```typescript
/**
 * æ¸¸æˆæœåŠ¡
 * 
 * @description å¤„ç†æ¸¸æˆæ ¸å¿ƒé€»è¾‘ï¼ŒåŒ…æ‹¬è½å­ã€èƒœè´Ÿåˆ¤æ–­ã€AIå¯¹æˆ˜ç­‰
 * @author å¼ ä¸‰
 * @date 2025-10-15
 */
```

#### 4.2.2 å‡½æ•°æ³¨é‡Š

```typescript
/**
 * åˆ›å»ºæ¸¸æˆæˆ¿é—´
 * 
 * @param userId åˆ›å»ºè€…ç”¨æˆ·ID
 * @param password æˆ¿é—´å¯†ç ï¼ˆå¯é€‰ï¼‰
 * @returns æˆ¿é—´ä¿¡æ¯
 * @throws RoomFullException æˆ¿é—´å·²æ»¡
 * @throws UnauthorizedException æœªæˆæƒ
 */
async createRoom(userId: string, password?: string): Promise<Room> {
  // å®ç°...
}
```

#### 4.2.3 å¤æ‚é€»è¾‘æ³¨é‡Š

```typescript
/**
 * è®¡ç®—ELOè¯„åˆ†å˜åŒ–
 * ä½¿ç”¨æ ‡å‡†ELOç®—æ³•: æ–°è¯„åˆ† = æ—§è¯„åˆ† + K * (å®é™…å¾—åˆ† - æœŸæœ›å¾—åˆ†)
 */
calculateRatingChange(playerRating: number, opponentRating: number, won: boolean): number {
  // è®¡ç®—æœŸæœ›å¾—åˆ†
  const expectedScore = 1 / (1 + Math.pow(10, (opponentRating - playerRating) / 400));
  
  // å®é™…å¾—åˆ†ï¼šèµ¢=1ï¼Œè¾“=0
  const actualScore = won ? 1 : 0;
  
  // è®¡ç®—è¯„åˆ†å˜åŒ–
  const ratingChange = GAME_CONFIG.RATING_K_FACTOR * (actualScore - expectedScore);
  
  return Math.round(ratingChange);
}
```

### 4.3 ä»£ç æ ¼å¼è§„èŒƒ

#### 4.3.1 ç¼©è¿›å’Œç©ºæ ¼

- ä½¿ç”¨ 2 ä¸ªç©ºæ ¼ç¼©è¿›
- æ“ä½œç¬¦ä¸¤è¾¹åŠ ç©ºæ ¼
- é€—å·ååŠ ç©ºæ ¼

```typescript
// âœ… æ­£ç¡®
const result = a + b;
const arr = [1, 2, 3];
function test(a: number, b: number) {}

// âŒ é”™è¯¯
const result=a+b;
const arr=[1,2,3];
function test(a:number,b:number){}
```

#### 4.3.2 ä»£ç è¡Œé•¿åº¦

- å•è¡Œä»£ç ä¸è¶…è¿‡ 100 ä¸ªå­—ç¬¦
- è¶…é•¿ä»£ç è¦æ¢è¡Œ

```typescript
// âœ… æ­£ç¡®
const game = await this.gameRecordRepository.findOne({
  where: { id: gameId },
  relations: ['blackPlayer', 'whitePlayer'],
});

// âŒ é¿å…
const game = await this.gameRecordRepository.findOne({ where: { id: gameId }, relations: ['blackPlayer', 'whitePlayer'] });
```

#### 4.3.3 å¯¼å…¥é¡ºåº

```typescript
// 1. Node.js å†…ç½®æ¨¡å—
import * as path from 'path';

// 2. ç¬¬ä¸‰æ–¹æ¨¡å—
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';

// 3. é¡¹ç›®å†…éƒ¨æ¨¡å—ï¼ˆæŒ‰å­—æ¯é¡ºåºï¼‰
import { GameService } from '@/modules/game/game.service';
import { UserService } from '@/modules/user/user.service';
import { GAME_CONFIG } from '@/common/constants/game.constants';
```

### 4.4 é”™è¯¯å¤„ç†è§„èŒƒ

```typescript
import { HttpException, HttpStatus } from '@nestjs/common';
import { ERROR_CODES, ERROR_MESSAGES } from '@/common/constants/error-codes.constants';

// âœ… ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯ç 
async findGame(gameId: string) {
  const game = await this.gameRecordRepository.findOne({ where: { id: gameId } });
  
  if (!game) {
    throw new HttpException(
      {
        code: ERROR_CODES.GAME_NOT_FOUND,
        message: ERROR_MESSAGES[ERROR_CODES.GAME_NOT_FOUND],
      },
      HttpStatus.NOT_FOUND,
    );
  }
  
  return game;
}

// âœ… ç»Ÿä¸€çš„å¼‚å¸¸è¿‡æ»¤å™¨
@Catch()
export class AllExceptionsFilter implements ExceptionFilter {
  catch(exception: any, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();
    
    const status = exception.getStatus?.() || HttpStatus.INTERNAL_SERVER_ERROR;
    const exceptionResponse = exception.getResponse?.();
    
    response.status(status).json({
      code: exceptionResponse?.code || ERROR_CODES.UNKNOWN_ERROR,
      message: exceptionResponse?.message || ERROR_MESSAGES[ERROR_CODES.UNKNOWN_ERROR],
      timestamp: new Date().toISOString(),
    });
  }
}
```

---

## äº”ã€æ•°æ®åº“å¼€å‘è§„èŒƒ

### 5.1 æŸ¥è¯¢ä¼˜åŒ–

```typescript
// âœ… ä½¿ç”¨ç´¢å¼•å­—æ®µæŸ¥è¯¢
const user = await this.userRepository.findOne({
  where: { openid: 'xxx' }, // openid æœ‰ç´¢å¼•
});

// âœ… åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
const users = await this.userRepository.find({
  select: ['id', 'nickname', 'avatar_url'],
  where: { level: 5 },
});

// âœ… ä½¿ç”¨åˆ†é¡µ
const [records, total] = await this.gameRecordRepository.findAndCount({
  skip: (page - 1) * limit,
  take: limit,
  order: { created_at: 'DESC' },
});

// âŒ é¿å…æŸ¥è¯¢å…¨è¡¨
const allUsers = await this.userRepository.find(); // å±é™©ï¼
```

### 5.2 äº‹åŠ¡å¤„ç†

```typescript
import { DataSource } from 'typeorm';

@Injectable()
export class GameService {
  constructor(private dataSource: DataSource) {}
  
  /**
   * æ¸¸æˆç»“æŸï¼Œæ›´æ–°åŒæ–¹æˆ˜ç»©ï¼ˆä½¿ç”¨äº‹åŠ¡ï¼‰
   */
  async finishGame(gameId: string, winnerId: string) {
    const queryRunner = this.dataSource.createQueryRunner();
    
    await queryRunner.connect();
    await queryRunner.startTransaction();
    
    try {
      // æ›´æ–°æ¸¸æˆè®°å½•
      await queryRunner.manager.update(GameRecord, gameId, {
        winnerId,
        endedAt: new Date(),
      });
      
      // æ›´æ–°èƒœè€…æˆ˜ç»©
      await queryRunner.manager.increment(
        User,
        { id: winnerId },
        'win_games',
        1,
      );
      
      // æ›´æ–°è´¥è€…æˆ˜ç»©
      await queryRunner.manager.increment(
        User,
        { id: loserId },
        'lose_games',
        1,
      );
      
      await queryRunner.commitTransaction();
    } catch (err) {
      await queryRunner.rollbackTransaction();
      throw err;
    } finally {
      await queryRunner.release();
    }
  }
}
```

---

## å…­ã€Redis ä½¿ç”¨è§„èŒƒ

### 6.1 Key å‘½åè§„èŒƒ

```typescript
/**
 * Redis Key å‘½åè§„èŒƒ
 * æ ¼å¼ï¼šæ¨¡å—:åŠŸèƒ½:å‚æ•°
 */
export const REDIS_KEYS = {
  // åœ¨çº¿ç”¨æˆ·
  ONLINE_USERS: 'online:users',
  
  // åŒ¹é…é˜Ÿåˆ—
  MATCH_QUEUE: 'match:queue',
  
  // æˆ¿é—´ä¿¡æ¯
  ROOM_INFO: (roomId: string) => `room:${roomId}:info`,
  
  // ç”¨æˆ·Socketæ˜ å°„
  USER_SOCKET: (userId: string) => `user:${userId}:socket`,
  
  // æ’è¡Œæ¦œç¼“å­˜
  LEADERBOARD: (type: string, period: string) => `leaderboard:${type}:${period}`,
} as const;
```

### 6.2 ä½¿ç”¨ç¤ºä¾‹

```typescript
import { Injectable } from '@nestjs/common';
import { RedisService } from '@/shared/redis/redis.service';
import { REDIS_KEYS } from '@/common/constants/redis-keys.constants';

@Injectable()
export class MatchService {
  constructor(private redisService: RedisService) {}
  
  /**
   * æ·»åŠ åˆ°åŒ¹é…é˜Ÿåˆ—
   */
  async addToMatchQueue(userId: string): Promise<void> {
    const timestamp = Date.now();
    await this.redisService.zadd(
      REDIS_KEYS.MATCH_QUEUE,
      timestamp,
      userId,
    );
  }
  
  /**
   * è·å–æˆ¿é—´ä¿¡æ¯
   */
  async getRoomInfo(roomId: string): Promise<any> {
    const key = REDIS_KEYS.ROOM_INFO(roomId);
    const data = await this.redisService.hgetall(key);
    return data;
  }
}
```

---

## ä¸ƒã€Git ä½¿ç”¨è§„èŒƒ

### 7.1 åˆ†æ”¯ç®¡ç†

```
main         - ä¸»åˆ†æ”¯ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
â”œâ”€â”€ develop  - å¼€å‘åˆ†æ”¯
    â”œâ”€â”€ feature/xxx  - åŠŸèƒ½åˆ†æ”¯
    â”œâ”€â”€ bugfix/xxx   - Bugä¿®å¤åˆ†æ”¯
    â””â”€â”€ hotfix/xxx   - ç´§æ€¥ä¿®å¤åˆ†æ”¯
```

### 7.2 Commit è§„èŒƒ

ä½¿ç”¨è¯­ä¹‰åŒ–æäº¤ä¿¡æ¯ï¼š

```bash
# æ ¼å¼
<type>(<scope>): <subject>

# ç±»å‹ï¼ˆtypeï¼‰
feat:     æ–°åŠŸèƒ½
fix:      ä¿®å¤bug
docs:     æ–‡æ¡£æ›´æ–°
style:    ä»£ç æ ¼å¼ï¼ˆä¸å½±å“ä»£ç è¿è¡Œï¼‰
refactor: é‡æ„
perf:     æ€§èƒ½ä¼˜åŒ–
test:     æµ‹è¯•
chore:    æ„å»º/å·¥å…·å˜åŠ¨

# ç¤ºä¾‹
feat(game): å®ç°äº”å­æ£‹AIç®—æ³•
fix(match): ä¿®å¤åŒ¹é…è¶…æ—¶é—®é¢˜
docs(api): æ›´æ–°APIæ–‡æ¡£
refactor(user): ä¼˜åŒ–ç”¨æˆ·æœåŠ¡ä»£ç ç»“æ„
```

### 7.3 ä»£ç æäº¤æµç¨‹

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin develop

# 2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/game-ai

# 3. å¼€å‘å¹¶æäº¤
git add .
git commit -m "feat(game): å®ç°Minimaxç®—æ³•"

# 4. æ¨é€åˆ°è¿œç¨‹
git push origin feature/game-ai

# 5. åˆ›å»ºPull Request
# åœ¨GitLab/GitHubä¸Šåˆ›å»ºPRï¼Œç­‰å¾…ä»£ç å®¡æŸ¥
```

---

## å…«ã€æµ‹è¯•è§„èŒƒ

### 8.1 å•å…ƒæµ‹è¯•

```typescript
import { Test, TestingModule } from '@nestjs/testing';
import { GameService } from './game.service';
import { getRepositoryToken } from '@nestjs/typeorm';
import { GameRecord } from './entities/game-record.entity';

describe('GameService', () => {
  let service: GameService;
  let mockRepository: any;
  
  beforeEach(async () => {
    mockRepository = {
      findOne: jest.fn(),
      save: jest.fn(),
      update: jest.fn(),
    };
    
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        GameService,
        {
          provide: getRepositoryToken(GameRecord),
          useValue: mockRepository,
        },
      ],
    }).compile();
    
    service = module.get<GameService>(GameService);
  });
  
  it('should be defined', () => {
    expect(service).toBeDefined();
  });
  
  describe('checkWin', () => {
    it('åº”è¯¥æ­£ç¡®è¯†åˆ«æ¨ªå‘äº”è¿', () => {
      const board = Array(15).fill(null).map(() => Array(15).fill(0));
      // æ¨¡æ‹Ÿæ¨ªå‘äº”è¿
      for (let i = 0; i < 5; i++) {
        board[7][i] = 1;
      }
      
      const result = service.checkWin(board, 7, 4, 1);
      expect(result).toBe(true);
    });
  });
});
```

---

## ä¹ã€æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### 9.1 é¿å…N+1æŸ¥è¯¢

```typescript
// âŒ N+1æŸ¥è¯¢é—®é¢˜
async getGamesWithPlayers(gameIds: string[]) {
  const games = await this.gameRecordRepository.findByIds(gameIds);
  
  for (const game of games) {
    game.blackPlayer = await this.userRepository.findOne(game.blackPlayerId); // Næ¬¡æŸ¥è¯¢
    game.whitePlayer = await this.userRepository.findOne(game.whitePlayerId); // Næ¬¡æŸ¥è¯¢
  }
  
  return games;
}

// âœ… ä½¿ç”¨å…³è”æŸ¥è¯¢
async getGamesWithPlayers(gameIds: string[]) {
  return this.gameRecordRepository.find({
    where: { id: In(gameIds) },
    relations: ['blackPlayer', 'whitePlayer'], // ä¸€æ¬¡æŸ¥è¯¢
  });
}
```

### 9.2 ä½¿ç”¨ç¼“å­˜

```typescript
/**
 * è·å–æ’è¡Œæ¦œï¼ˆå¸¦ç¼“å­˜ï¼‰
 */
async getLeaderboard(type: string, period: string) {
  const cacheKey = REDIS_KEYS.LEADERBOARD(type, period);
  
  // å…ˆä»ç¼“å­˜è·å–
  const cached = await this.redisService.get(cacheKey);
  if (cached) {
    return JSON.parse(cached);
  }
  
  // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
  const data = await this.leaderboardRepository.find({
    where: { rank_type: type, period },
    order: { rank: 'ASC' },
    take: 100,
  });
  
  // å†™å…¥ç¼“å­˜
  await this.redisService.setex(
    cacheKey,
    RANK_CONFIG.CACHE_TTL,
    JSON.stringify(data),
  );
  
  return data;
}
```

---

## åã€å®‰å…¨è§„èŒƒ

### 10.1 è¾“å…¥éªŒè¯

```typescript
// âœ… ä½¿ç”¨DTO + class-validator éªŒè¯æ‰€æœ‰è¾“å…¥
@Post('move')
async makeMove(@Body() dto: MakeMoveDto) {
  // DTOå·²è‡ªåŠ¨éªŒè¯ï¼Œå®‰å…¨
  return this.gameService.makeMove(dto);
}
```

### 10.2 SQLæ³¨å…¥é˜²æŠ¤

```typescript
// âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
const users = await this.userRepository
  .createQueryBuilder('user')
  .where('user.nickname = :nickname', { nickname })
  .getMany();

// âŒ é¿å…å­—ç¬¦ä¸²æ‹¼æ¥
const users = await this.userRepository.query(
  `SELECT * FROM users WHERE nickname = '${nickname}'`, // å±é™©ï¼
);
```

### 10.3 æ•æ„Ÿä¿¡æ¯å¤„ç†

```typescript
// âœ… æ’é™¤æ•æ„Ÿå­—æ®µ
@Entity('users')
export class User {
  @Column({ select: false })  // é»˜è®¤æŸ¥è¯¢æ—¶ä¸è¿”å›
  password: string;
  
  @Column({ select: false })
  openid: string;
}

// æ‰‹åŠ¨æ’é™¤
const user = await this.userRepository.findOne({ where: { id } });
delete user.openid;
return user;
```

---

## åä¸€ã€å¼€å‘æ£€æŸ¥æ¸…å•

### 11.1 ä»£ç æäº¤å‰æ£€æŸ¥

- [ ] å·²é˜…è¯»ç›¸å…³çš„äº§å“éœ€æ±‚æ–‡æ¡£
- [ ] ä»£ç ä¸­æ²¡æœ‰ç¡¬ç¼–ç ï¼Œæ‰€æœ‰å¸¸é‡éƒ½åœ¨ constants ä¸­å®šä¹‰
- [ ] æ‰€æœ‰é…ç½®éƒ½ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶
- [ ] ä»£ç ç¬¦åˆå‘½åè§„èŒƒ
- [ ] æ·»åŠ äº†å¿…è¦çš„æ³¨é‡Š
- [ ] æ²¡æœ‰console.logç­‰è°ƒè¯•ä»£ç 
- [ ] é€šè¿‡äº†ESLintæ£€æŸ¥
- [ ] ç¼–å†™äº†å•å…ƒæµ‹è¯•
- [ ] æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å·²æ ¼å¼åŒ–ï¼ˆPrettierï¼‰
- [ ] Git commit ä¿¡æ¯ç¬¦åˆè§„èŒƒ

### 11.2 åŠŸèƒ½å¼€å‘å®Œæˆæ£€æŸ¥

- [ ] åŠŸèƒ½ç¬¦åˆäº§å“éœ€æ±‚æ–‡æ¡£
- [ ] APIæ¥å£ç¬¦åˆæŠ€æœ¯å¼€å‘æ–‡æ¡£è®¾è®¡
- [ ] æ•°æ®åº“æ“ä½œå·²ä¼˜åŒ–ï¼ˆç´¢å¼•ã€æŸ¥è¯¢ï¼‰
- [ ] æ·»åŠ äº†é”™è¯¯å¤„ç†
- [ ] æ·»åŠ äº†æ—¥å¿—è®°å½•
- [ ] è¿›è¡Œäº†æ‰‹åŠ¨æµ‹è¯•
- [ ] æ›´æ–°äº†ç›¸å…³æ–‡æ¡£
- [ ] é€šè¿‡äº†Code Review

---

## åäºŒã€å¸¸è§é—®é¢˜FAQ

### Q1: ä»€ä¹ˆæ—¶å€™åº”è¯¥å®šä¹‰æ–°çš„å¸¸é‡ï¼Ÿ

**A:** å½“ä½ å‘ç°ä»£ç ä¸­å‡ºç°ä»¥ä¸‹æƒ…å†µæ—¶ï¼š
- æ•°å­—/å­—ç¬¦ä¸²è¢«å¤šæ¬¡ä½¿ç”¨
- æ•°å­—/å­—ç¬¦ä¸²æœ‰ç‰¹å®šä¸šåŠ¡å«ä¹‰
- å¯èƒ½éœ€è¦åç»­è°ƒæ•´çš„å€¼

### Q2: å¸¸é‡åº”è¯¥æ”¾åœ¨å“ªé‡Œï¼Ÿ

**A:** 
- å…¨å±€ä¸šåŠ¡å¸¸é‡ï¼š`src/common/constants/`
- æ¨¡å—å†…éƒ¨å¸¸é‡ï¼šæ¨¡å—ç›®å½•ä¸‹çš„ `constants/` æ–‡ä»¶å¤¹

### Q3: å¦‚ä½•é¿å…å¾ªç¯ä¾èµ–ï¼Ÿ

**A:**
- åˆç†åˆ’åˆ†æ¨¡å—èŒè´£
- ä½¿ç”¨ `forwardRef()` è§£å†³å¿…è¦çš„å¾ªç¯ä¾èµ–
- å°†å…±äº«é€»è¾‘æŠ½å–åˆ°ç‹¬ç«‹çš„ shared æ¨¡å—

### Q4: æ•°æ®åº“å­—æ®µå˜æ›´å¦‚ä½•å¤„ç†ï¼Ÿ

**A:**
- ç¼–å†™migrationæ–‡ä»¶
- æ›´æ–°Entityå®šä¹‰
- æ›´æ–°ç›¸å…³æ–‡æ¡£
- é€šçŸ¥å›¢é˜Ÿæˆå‘˜

---

## åä¸‰ã€å¼€å‘å·¥å…·æ¨è

### 13.1 VS Code æ’ä»¶

- **ESLint** - ä»£ç æ£€æŸ¥
- **Prettier** - ä»£ç æ ¼å¼åŒ–
- **GitLens** - Gitå¢å¼º
- **Thunder Client** - APIæµ‹è¯•
- **Todo Tree** - TODOç®¡ç†
- **Error Lens** - é”™è¯¯æç¤ºå¢å¼º

### 13.2 é…ç½®æ–‡ä»¶

**`.prettierrc`**
```json
{
  "singleQuote": true,
  "trailingComma": "all",
  "printWidth": 100,
  "tabWidth": 2,
  "semi": true,
  "arrowParens": "always"
}
```

**`.eslintrc.js`**
```javascript
module.exports = {
  parser: '@typescript-eslint/parser',
  parserOptions: {
    project: 'tsconfig.json',
    sourceType: 'module',
  },
  plugins: ['@typescript-eslint/eslint-plugin'],
  extends: [
    'plugin:@typescript-eslint/recommended',
    'plugin:prettier/recommended',
  ],
  root: true,
  env: {
    node: true,
    jest: true,
  },
  rules: {
    '@typescript-eslint/interface-name-prefix': 'off',
    '@typescript-eslint/explicit-function-return-type': 'off',
    '@typescript-eslint/explicit-module-boundary-types': 'off',
    '@typescript-eslint/no-explicit-any': 'warn',
  },
};
```

---

## åå››ã€æ€»ç»“

æœ¬å¼€å‘è§„èŒƒæ–‡æ¡£çš„æ ¸å¿ƒåŸåˆ™ï¼š

1. **ğŸ“– æ–‡æ¡£å…ˆè¡Œ** - å¼€å‘å‰å¿…è¯»docsæ–‡ä»¶å¤¹æ‰€æœ‰æ–‡æ¡£
2. **ğŸš« ç¦æ­¢ç¡¬ç¼–ç ** - æ‰€æœ‰å¸¸é‡ã€é…ç½®å¿…é¡»å¤–éƒ¨åŒ–
3. **ğŸ“¦ æ¨¡å—åŒ–å¼€å‘** - éµå¾ªNestJSæœ€ä½³å®è·µ
4. **âœ… ä»£ç è§„èŒƒ** - ç»Ÿä¸€çš„å‘½åã€æ³¨é‡Šã€æ ¼å¼
5. **ğŸ”’ å®‰å…¨ç¬¬ä¸€** - è¾“å…¥éªŒè¯ã€SQLæ³¨å…¥é˜²æŠ¤
6. **âš¡ æ€§èƒ½ä¼˜åŒ–** - é¿å…N+1ã€ä½¿ç”¨ç¼“å­˜
7. **ğŸ§ª æµ‹è¯•è¦†ç›–** - ç¼–å†™å•å…ƒæµ‹è¯•
8. **ğŸ“ æ¸…æ™°æ³¨é‡Š** - å¤æ‚é€»è¾‘å¿…é¡»æ³¨é‡Š

**è¯·æ¯ä½å¼€å‘äººå‘˜ä¸¥æ ¼éµå®ˆæœ¬è§„èŒƒï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œé¡¹ç›®å¯ç»´æŠ¤æ€§ï¼**

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** V1.0  
**åˆ›å»ºæ—¥æœŸï¼š** 2025-10-15  
**æœ€åæ›´æ–°ï¼š** 2025-10-15  
**ç»´æŠ¤äººå‘˜ï¼š** æŠ€æœ¯å›¢é˜Ÿ  

**é‡è¦æé†’ï¼š** 
> æœ¬æ–‡æ¡£ä¼šæŒç»­æ›´æ–°ï¼Œè¯·å®šæœŸæŸ¥é˜…ã€‚å¦‚æœ‰ç–‘é—®æˆ–å»ºè®®ï¼Œè¯·åŠæ—¶ä¸æŠ€æœ¯è´Ÿè´£äººæ²Ÿé€šã€‚

